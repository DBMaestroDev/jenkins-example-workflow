pipeline {
    agent any

    parameters {
        string(name: 'TASK_ID', defaultValue: 'TASK0000001', description: 'ServiceNow Task ID (e.g., TASK0000001)')
        choice(name: 'DBM_PROJECT_NAME', choices: ['Demo-PSQL', 'DemoProject2', 'DemoProject3', 'DemoProject4'], description: 'DBmaestro project name')
        string(name: 'DBM_PACKAGE_NAME', defaultValue: '', description: 'DBmaestro package name (if empty, defaults to Request Item ID)')
        booleanParam(name: 'PACKAGE_ALREADY_EXIST', defaultValue: false, description: 'If checked, skip package creation (package already exists in DBmaestro)')
    }

    environment {
        // ServiceNow endpoint and credentials
        SERVICENOW_ENDPOINT = credentials('servicenow-endpoint')
        SERVICENOW_TABLE = 'task'

        // DBmaestro configuration
        DBM_JAR_PATH = 'C:\\Program Files (x86)\\DBmaestro\\DOP Server\\Agent\\DBmaestroAgent.jar'
        DBM_AGENT_ENDPOINT = 'DELL-NICOLAST:8017'
        DBM_ENV_NAME_DEV = 'Dev_Env_1'
        DBM_ENV_NAME_RS = 'Release Source'
        DBM_ENV_NAME_PROD = 'Prod_Env_1'
        DBM_PROJECT_NAME = "${params.DBM_PROJECT_NAME}"
        DBM_AUTH_TYPE = 'DBmaestroAccount'

        // Poll interval for status checks (in seconds)
        POLL_INTERVAL = '30'
        MAX_WAIT_TIME = '3600'  // 1 hour
    }

    stages {
        stage('Validate Parameters') {
            steps {
                lock(resource: "task-${params.TASK_ID}", skipIfLocked: true) {
                    script {
                        if (!params.TASK_ID?.trim()) {
                            error("TASK_ID parameter is required. Provide a ServiceNow Task ID.")
                        }
                        env.TASK_ID = params.TASK_ID.trim()
                        echo "Using Task ID: ${env.TASK_ID}"

                        // Set build display name to the Task ID
                        currentBuild.displayName = "${env.TASK_ID}"
                    }
                }
            }
        }

        stage('Verify Task ID Exists') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                        echo "Querying ServiceNow for Task ID: ${env.TASK_ID}"

                        def response = powershell(returnStdout: true, script: """
                            \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                            \$table = "\$env:SERVICENOW_TABLE"
                            \$taskId = "${env.TASK_ID}"
                            
                            # Build the URL with proper query encoding and field restriction
                            \$queryValue = [Uri]::EscapeDataString("number=\$taskId")
                            \$fieldsValue = [Uri]::EscapeDataString("number,state,sys_id,parent")
                            \$url = \$endpoint + "/api/now/table/" + \$table + "?sysparm_query=" + \$queryValue + "&sysparm_fields=" + \$fieldsValue + "&sysparm_limit=1&sysparm_display_value=true"
                            
                            \$username = "\$env:SN_USER"
                            \$password = "\$env:SN_PASS"
                            \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                            \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                            \$headers = @{
                                "Accept" = "application/json"
                            }

                            try {
                                \$response = Invoke-RestMethod -Uri \$url -Method Get -Credential \$credential -Headers \$headers -ErrorAction Stop
                                if (\$response.result.Count -gt 0) {
                                    \$change = \$response.result[0]
                                    Write-Output (\$change | ConvertTo-Json -Compress)
                                } else {
                                    Write-Output "NOT_FOUND"
                                }
                            } catch {
                                Write-Error "ServiceNow API query failed: \$_"
                                exit 1
                            }
                        """).trim()

                        if (response == "NOT_FOUND") {
                            error("Task ID ${env.TASK_ID} not found in ServiceNow.")
                        } else if (response.isEmpty() || response.startsWith("ERROR")) {
                            error("Failed to query ServiceNow: ${response}")
                        }

                        // Parse JSON response and extract status, sys_id, parent info and other details
                        def jsonSlurper = new groovy.json.JsonSlurper()
                        def taskInfo = jsonSlurper.parseText(response)
                        env.TASK_STATUS = taskInfo.state ?: 'unknown'
                        env.TASK_SHORT_DESC = taskInfo.short_description ?: 'N/A'
                        env.TASK_SYS_ID = taskInfo.sys_id ?: ''
                        env.TASK_PARENT_DISPLAY_VALUE = taskInfo.parent?.display_value ?: ''
                        
                        // Set DBM_PACKAGE_NAME to parent display_value if available, otherwise to TASK_ID
                        if (params.DBM_PACKAGE_NAME?.trim()) {
                            env.DBM_PACKAGE_NAME = params.DBM_PACKAGE_NAME.trim()
                        } else if (env.TASK_PARENT_DISPLAY_VALUE?.trim()) {
                            env.DBM_PACKAGE_NAME = env.TASK_PARENT_DISPLAY_VALUE.trim()
                        } else {
                            env.DBM_PACKAGE_NAME = env.TASK_ID
                        }
                        echo "Using DBmaestro Package Name: ${env.DBM_PACKAGE_NAME}"
                        
                        // Check if Task ID is in closed state (state contains "Closed")
                        if (env.TASK_STATUS?.contains("Closed")) {
                            error("Task ID ${env.TASK_ID} is in closed state and cannot be processed.")
                        }
                        
                        echo "Found Task ID: ${env.TASK_ID} | sys_id: ${env.TASK_SYS_ID} | Status: ${env.TASK_STATUS} | Parent: ${env.TASK_PARENT_DISPLAY_VALUE} | Description: ${env.TASK_SHORT_DESC}"
                    }
                }
            }
        }

        stage('Create Package in DBmaestro') {
            when {
                expression { !params.PACKAGE_ALREADY_EXIST }
            }
            steps {
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    java -jar "\$env:DBM_JAR_PATH" -Build -ProjectName "\$env:DBM_PROJECT_NAME" -EnvName "\$env:DBM_ENV_NAME_DEV" -VersionType "Tasks" -AdditionalInformation "${env.DBM_PACKAGE_NAME}" -CreatePackage True -PackageName "${env.DBM_PACKAGE_NAME}" -Server "\$env:DBM_AGENT_ENDPOINT" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }

        // Post a work note to ServiceNow that the DBmaestro package was created
        stage('Post Comment: Package Created') {
            when {
                expression { !params.PACKAGE_ALREADY_EXIST }
            }
            steps {
                script {
                    if (env.TASK_SYS_ID?.trim()) {
                        withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                            powershell """
                            \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                            \$table = "\$env:SERVICENOW_TABLE"
                            \$sysId = "${env.TASK_SYS_ID}"
                            if ([string]::IsNullOrEmpty(\$sysId)) { Write-Output "SKIP"; exit 0 }
                            \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                            \$overviewUrl = "\$buildUrl/pipeline-overview"
                            \$message = @"
DBmaestro package ${env.DBM_PACKAGE_NAME} created

Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]

Status: Waiting for change to be scheduled before deploying to ${env.DBM_ENV_NAME_RS}
"@
                            \$body = @{ work_notes = \$message } | ConvertTo-Json

                            \$username = "\$env:SN_USER"
                            \$password = "\$env:SN_PASS"
                            \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                            \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                            \$headers = @{
                                "Accept" = "application/json"
                                "Content-Type" = "application/json"
                            }

                            try {
                                Invoke-RestMethod -Uri (\$endpoint + "/api/now/table/" + \$table + "/" + \$sysId) -Method Patch -Credential \$credential -Headers \$headers -Body \$body -ErrorAction Stop
                                Write-Output "Posted package-created note to ServiceNow"
                            } catch {
                                Write-Output "Failed to post package-created note: \$_"
                                # do not fail the pipeline for comment posting
                            }
                            """
                        }
                    } else {
                        echo "Skipping ServiceNow comment post: Task sys_id not available"
                    }
                }
            }
        }

        stage('Precheck Package in DBmaestro') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    java -jar "\$env:DBM_JAR_PATH" -PreCheck -ProjectName "\$env:DBM_PROJECT_NAME" -Server "\$env:DBM_AGENT_ENDPOINT" -PackageName "${env.DBM_PACKAGE_NAME}" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }

        // Post a work note to ServiceNow that the DBmaestro precheck completed
        stage('Post Comment: Precheck Completed') {
            steps {
                script {
                    if (env.TASK_SYS_ID?.trim()) {
                        withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                            powershell """
                            \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                            \$table = "\$env:SERVICENOW_TABLE"
                            \$sysId = "${env.TASK_SYS_ID}"
                            if ([string]::IsNullOrEmpty(\$sysId)) { Write-Output "SKIP"; exit 0 }
                            \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                            \$overviewUrl = "\$buildUrl/pipeline-overview"
                            \$message = @"
DBmaestro precheck completed

Package: ${env.DBM_PACKAGE_NAME}
Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]
"@
                            \$body = @{ work_notes = \$message } | ConvertTo-Json

                            \$username = "\$env:SN_USER"
                            \$password = "\$env:SN_PASS"
                            \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                            \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                            \$headers = @{
                                "Accept" = "application/json"
                                "Content-Type" = "application/json"
                            }

                            try {
                                Invoke-RestMethod -Uri (\$endpoint + "/api/now/table/" + \$table + "/" + \$sysId) -Method Patch -Credential \$credential -Headers \$headers -Body \$body -ErrorAction Stop
                                Write-Output "Posted precheck-completed note to ServiceNow"
                            } catch {
                                Write-Output "Failed to post precheck-completed note: \$_"
                            }
                            """
                        }
                    } else {
                        echo "Skipping ServiceNow comment post: Task sys_id not available"
                    }
                }
            }
        }

        stage('Wait for Task to be in "Work in Progress" state') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                        echo "Waiting for Task ID ${env.TASK_ID} to reach 'Work in Progress' status..."

                        def maxWaitSeconds = Integer.parseInt(env.MAX_WAIT_TIME)
                        def pollIntervalSeconds = Integer.parseInt(env.POLL_INTERVAL)
                        def elapsedTime = 0
                        def isWorkInProgress = false

                        while (elapsedTime < maxWaitSeconds && !isWorkInProgress) {
                            sleep(time: pollIntervalSeconds, unit: 'SECONDS')
                            elapsedTime += pollIntervalSeconds

                            def response = powershell(returnStdout: true, script: """
                                \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                                \$table = "\$env:SERVICENOW_TABLE"
                                \$taskId = "${env.TASK_ID}"
                                
                                # Build the URL with proper query encoding
                                \$queryValue = [Uri]::EscapeDataString("number=\$taskId")
                                \$url = \$endpoint + "/api/now/table/" + \$table + "?sysparm_query=" + \$queryValue + "&sysparm_limit=1"
                                
                                \$username = "\$env:SN_USER"
                                \$password = "\$env:SN_PASS"
                                \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                                \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                                \$headers = @{
                                    "Accept" = "application/json"
                                }

                                try {
                                    \$response = Invoke-RestMethod -Uri \$url -Method Get -Credential \$credential -Headers \$headers -ErrorAction Stop
                                    if (\$response.result.Count -gt 0) {
                                        \$change = \$response.result[0]
                                        Write-Output \$change.state
                                    }
                                } catch {
                                    Write-Error "ServiceNow API query failed: \$_"
                                    exit 1
                                }
                            """).trim()

                            if (response == "2" || response.contains("2")) {
                                isWorkInProgress = true
                                echo "Task ID reached 'Work in Progress' status."
                            } else {
                                echo "Current status: ${response} | Elapsed time: ${elapsedTime}s / ${maxWaitSeconds}s"
                            }
                        }

                        if (!isWorkInProgress) {
                            error("Timeout waiting for Task ID to be in 'Work in Progress' state. Max wait time: ${env.MAX_WAIT_TIME}s")
                        }
                    }
                }
            }
        }

        stage('Upgrade Release Source Environment') {
            steps {
                script {
                    def keepTrying = true
                    while (keepTrying) {
                        try {
                            withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                                powershell """
                                java -jar "\$env:DBM_JAR_PATH" -Upgrade -ProjectName "\$env:DBM_PROJECT_NAME" -EnvName "\$env:DBM_ENV_NAME_RS" -PackageName "${env.DBM_PACKAGE_NAME}" -BackupBehavior True -RestoreBehavior True -Server "\$env:DBM_AGENT_ENDPOINT" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                                """
                            }
                            echo "Release Source upgrade succeeded for package ${env.TASK_ID}"
                            // Post success note to ServiceNow (best-effort)
                            if (env.TASK_SYS_ID?.trim()) {
                                withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                                    powershell """
                                    \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                                    \$table = "\$env:SERVICENOW_TABLE"
                                    \$sysId = "${env.TASK_SYS_ID}"
                                    \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                                    \$overviewUrl = "\$buildUrl/pipeline-overview"
                                    \$message = @"
Release Source upgrade SUCCEEDED

Package: ${env.DBM_PACKAGE_NAME}
Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]
"@
                                    \$body = @{ work_notes = \$message } | ConvertTo-Json

                                    \$username = "\$env:SN_USER"
                                    \$password = "\$env:SN_PASS"
                                    \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                                    \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                                    \$headers = @{
                                        "Accept" = "application/json"
                                        "Content-Type" = "application/json"
                                    }

                                    try {
                                        Invoke-RestMethod -Uri (\$endpoint + "/api/now/table/" + \$table + "/" + \$sysId) -Method Patch -Credential \$credential -Headers \$headers -Body \$body -ErrorAction Stop
                                        Write-Output "Posted RS-upgrade-success note to ServiceNow"
                                    } catch {
                                        Write-Output "Failed to post RS-upgrade-success note: \$_"
                                    }
                                    """
                                }
                            } else {
                                echo "Skipping ServiceNow success comment: Task sys_id not available"
                            }
                            keepTrying = false
                        } catch (err) {
                            echo "Upgrade attempt failed: ${err}"
                            // Post a failure note to ServiceNow (non-fatal for comment posting)
                            try {
                                if (env.TASK_SYS_ID?.trim()) {
                                    withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                                        powershell """
                                        \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                                        \$table = "\$env:SERVICENOW_TABLE"
                                        \$sysId = "${env.TASK_SYS_ID}"
                                        \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                                        \$overviewUrl = "\$buildUrl/pipeline-overview"
                                        \$message = @"
Release Source upgrade FAILED

Package: ${env.DBM_PACKAGE_NAME}
Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]

Error: ${err}
"@
                                        \$body = @{ work_notes = \$message } | ConvertTo-Json

                                        \$username = "\$env:SN_USER"
                                        \$password = "\$env:SN_PASS"
                                        \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                                        \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                                        \$headers = @{
                                            "Accept" = "application/json"
                                            "Content-Type" = "application/json"
                                        }

                                        try {
                                            Invoke-RestMethod -Uri (\$endpoint + "/api/now/table/" + \$table + "/" + \$sysId) -Method Patch -Credential \$credential -Headers \$headers -Body \$body -ErrorAction Stop
                                            Write-Output "Posted RS-upgrade-failure note to ServiceNow"
                                        } catch {
                                            Write-Output "Failed to post RS-upgrade-failure note: \$_"
                                        }
                                        """
                                    }
                                } else {
                                    echo "Skipping ServiceNow failure comment: Task sys_id not available"
                                }
                            } catch (postErr) {
                                echo "Posting failure note also failed: ${postErr}"
                            }

                            def action = input message: "Upgrade failed for package ${env.TASK_ID}. Choose action:", parameters: [choice(name: 'ACTION', choices: 'Retry\nAbort', description: 'Retry will attempt the upgrade again; Abort will stop the pipeline.')], ok: 'Proceed'
                            if (action == 'Abort') {
                                error("Upgrade aborted by user after failure.")
                            } else {
                                echo "User chose to retry the upgrade. Retrying..."
                            }
                        }
                    }
                }
            }
        }

        // stage('Wait for Change to be Implemented') {
        //     steps {
        //         script {
        //             withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
        //                 echo "Waiting for Task ID ${env.TASK_ID} to reach 'implement' status..."

        //                 def maxWaitSeconds = Integer.parseInt(env.MAX_WAIT_TIME)
        //                 def pollIntervalSeconds = Integer.parseInt(env.POLL_INTERVAL)
        //                 def elapsedTime = 0
        //                 def isImplemented = false

        //                 while (elapsedTime < maxWaitSeconds && !isImplemented) {
        //                     sleep(time: pollIntervalSeconds, unit: 'SECONDS')
        //                     elapsedTime += pollIntervalSeconds

        //                     def response = powershell(returnStdout: true, script: """
        //                         \$endpoint = "\$env:SERVICENOW_ENDPOINT"
        //                         \$table = "\$env:SERVICENOW_TABLE"
        //                         \$taskId = "${env.TASK_ID}"
                                
        //                         # Build the URL with proper query encoding
        //                         \$queryValue = [Uri]::EscapeDataString("number=\$taskId")
        //                         \$url = \$endpoint + "/api/now/table/" + \$table + "?sysparm_query=" + \$queryValue + "&sysparm_limit=1"
                                
        //                         \$username = "\$env:SN_USER"
        //                         \$password = "\$env:SN_PASS"
        //                         \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
        //                         \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

        //                         \$headers = @{
        //                             "Accept" = "application/json"
        //                         }

        //                         try {
        //                             \$response = Invoke-RestMethod -Uri \$url -Method Get -Credential \$credential -Headers \$headers -ErrorAction Stop
        //                             if (\$response.result.Count -gt 0) {
        //                                 \$change = \$response.result[0]
        //                                 Write-Output \$change.state
        //                             }
        //                         } catch {
        //                             Write-Error "ServiceNow API query failed: \$_"
        //                             exit 1
        //                         }
        //                     """).trim()

        //                     if (response == "-1" || response.contains("-1")) {
        //                         isImplemented = true
        //                         echo "Task ID reached 'implement' status."
        //                     } else {
        //                         echo "Current status: ${response} | Elapsed time: ${elapsedTime}s / ${maxWaitSeconds}s"
        //                     }
        //                 }

        //                 if (!isImplemented) {
        //                     error("Timeout waiting for Task ID to be implemented. Max wait time: ${env.MAX_WAIT_TIME}s")
        //                 }
        //             }
        //         }
        //     }
        // }

        stage('Upgrade Production Environment') {
            steps {
                script {
                    def keepTrying = true
                    while (keepTrying) {
                        try {
                            withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                                powershell """
                                java -jar "\$env:DBM_JAR_PATH" -Upgrade -ProjectName "\$env:DBM_PROJECT_NAME" -EnvName "\$env:DBM_ENV_NAME_PROD" -PackageName "${env.DBM_PACKAGE_NAME}" -BackupBehavior True -RestoreBehavior True -Server "\$env:DBM_AGENT_ENDPOINT" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                                """
                            }
                            echo "Production upgrade succeeded for package ${env.TASK_ID}"
                            keepTrying = false
                        
                            // Post success note to ServiceNow (best-effort)
                            if (env.TASK_SYS_ID?.trim()) {
                                withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                                    powershell """
                                    \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                                    \$table = "\$env:SERVICENOW_TABLE"
                                    \$sysId = "${env.TASK_SYS_ID}"
                                    \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                                    \$overviewUrl = "\$buildUrl/pipeline-overview"
                                    \$message = @"
Production upgrade SUCCEEDED

Package: ${env.DBM_PACKAGE_NAME}
Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]
"@
                                    \$body = @{ work_notes = \$message } | ConvertTo-Json

                                    \$username = "\$env:SN_USER"
                                    \$password = "\$env:SN_PASS"
                                    \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                                    \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                                    \$headers = @{
                                        "Accept" = "application/json"
                                        "Content-Type" = "application/json"
                                    }

                                    try {
                                        Invoke-RestMethod -Uri (\$endpoint + "/api/now/table/" + \$table + "/" + \$sysId) -Method Patch -Credential \$credential -Headers \$headers -Body \$body -ErrorAction Stop
                                        Write-Output "Posted Prod-upgrade-success note to ServiceNow"
                                    } catch {
                                        Write-Output "Failed to post Prod-upgrade-success note: \$_"
                                    }
                                    """
                                }
                            } else {
                                echo "Skipping ServiceNow success comment: Task sys_id not available"
                            }
                        } catch (err) {
                            echo "Production upgrade attempt failed: ${err}"
                            // Post a failure note to ServiceNow (best-effort)
                            try {
                                if (env.TASK_SYS_ID?.trim()) {
                                    withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                                        powershell """
                                        \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                                        \$table = "\$env:SERVICENOW_TABLE"
                                        \$sysId = "${env.TASK_SYS_ID}"
                                        \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                                        \$overviewUrl = "\$buildUrl/pipeline-overview"
                                        \$message = @"
Production upgrade FAILED

Package: ${env.DBM_PACKAGE_NAME}
Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]

Error: ${err}
"@
                                        \$body = @{ work_notes = \$message } | ConvertTo-Json

                                        \$username = "\$env:SN_USER"
                                        \$password = "\$env:SN_PASS"
                                        \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                                        \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                                        \$headers = @{
                                            "Accept" = "application/json"
                                            "Content-Type" = "application/json"
                                        }

                                        try {
                                            Invoke-RestMethod -Uri (\$endpoint + "/api/now/table/" + \$table + "/" + \$sysId) -Method Patch -Credential \$credential -Headers \$headers -Body \$body -ErrorAction Stop
                                            Write-Output "Posted Prod-upgrade-failure note to ServiceNow"
                                        } catch {
                                            Write-Output "Failed to post Prod-upgrade-failure note: \$_"
                                        }
                                        """
                                    }
                                } else {
                                    echo "Skipping ServiceNow failure comment: Task sys_id not available"
                                }
                            } catch (postErr) {
                                echo "Posting failure note also failed: ${postErr}"
                            }

                            def action = input message: "Production upgrade failed for package ${env.TASK_ID}. Choose action:", parameters: [choice(name: 'ACTION', choices: 'Retry\nAbort', description: 'Retry will attempt the upgrade again; Abort will stop the pipeline.')], ok: 'Proceed'
                            if (action == 'Abort') {
                                error("Production upgrade aborted by user after failure.")
                            } else {
                                echo "User chose to retry the production upgrade. Retrying..."
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Completed ServiceNow change integration pipeline. TASK_ID=${env.TASK_ID} | Final Status=${env.TASK_STATUS}"
        }
        success {
            echo "Successfully deployed Task ID ${env.TASK_ID} through all environments."
        }
        failure {
            echo "Pipeline failed for Task ID ${env.TASK_ID}. Review logs for details."
        }
    }
}
