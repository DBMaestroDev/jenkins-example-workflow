pipeline {
    // version: 1.0
    // This pipeline creates a DBmaestro package from Source Control based on a ServiceNow Task or CTask ID.
    // It performs the following steps:
    // 1. Validates input parameters
    // 2. Verifies that the provided Task ID exists in ServiceNow and is not closed
    // 3. Creates a DBmaestro package
    // 4. Posts a comment to the ServiceNow task indicating package creation
    // 5. Performs a precheck of the package in DBmaestro
    // 6. Posts a comment to the ServiceNow task indicating precheck completion
    // 7. Optionally upgrades the package in the Release Source environment, with retry on failure
    agent any

    parameters {
        string(name: 'SN_TASK_ID', defaultValue: 'TASK0000001', description: 'ServiceNow Task or CTask ID (e.g., TASK0000001)')
        choice(name: 'DBM_PROJECT_NAME', choices: ['CHGMTEST', 'GUIDE', 'Demo-PSQL', 'DemoProject2', 'DemoProject3', 'DemoProject4'], description: 'DBmaestro project name')
        string(name: 'SC_TASK_ID', defaultValue: '', description: 'Source Control task ID (if empty, defaults to Task or CTask ID)')
        string(name: 'DBM_PACKAGE_NAME', defaultValue: '', description: 'DBmaestro package name (if empty, defaults to Task or CTask ID)')
        booleanParam(name: 'PACKAGE_ALREADY_EXIST', defaultValue: false, description: 'If checked, skip package creation (package already exists in DBmaestro)')
        booleanParam(name: 'UPGRADE_RS_ENVIRONMENT', defaultValue: false, description: 'If checked, upgrade package in Release Source environment after precheck')
    }

    environment {
        // ServiceNow endpoint is on text credentials:
        // 'servicenow-endpoint'
        
        // DBmaestro configuration
        DBM_JAR_PATH = 'C:\\Program Files (x86)\\DBmaestro\\DOP Server\\Agent\\DBmaestroAgent.jar'
        DBM_AGENT_ENDPOINT = 'localhost:8017'
        DBM_ENV_NAME_DEV = "dev_${params.DBM_PROJECT_NAME}"
        DBM_ENV_NAME = "rs_${params.DBM_PROJECT_NAME}"
        DBM_PROJECT_NAME = "${params.DBM_PROJECT_NAME}"
        DBM_AUTH_TYPE = 'DBmaestroAccount'
        DBM_USE_SSL = 'True'
    }

    stages {
        stage('Validate Parameters') {
            steps {
                    script {
                        if (!params.SN_TASK_ID?.trim()) {
                            error("SN_TASK_ID parameter is required. Provide a ServiceNow Task ID.")
                        }
                        env.SN_TASK_ID = params.SN_TASK_ID.trim()
                        
                        // Determine ServiceNow table based on SN_TASK_ID prefix
                        if (env.SN_TASK_ID.startsWith('CTASK')) {
                            env.SERVICENOW_TABLE = 'change_task'
                        } else if (env.SN_TASK_ID.startsWith('TASK')) {
                            env.SERVICENOW_TABLE = 'sc_task'
                        } else {
                            error("SN_TASK_ID must start with 'TASK' or 'CTASK'. Provided: ${env.SN_TASK_ID}")
                        }
                        
                        echo "Using Task ID: ${env.SN_TASK_ID} (Table: ${env.SERVICENOW_TABLE})"

                        // Set build display name to the Task ID
                        currentBuild.displayName = "${env.SN_TASK_ID}"
                    }
            }
        }

        stage('Verify Task ID Exists') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'JENKINS_DBA_USER', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS'), string(credentialsId: 'servicenow-endpoint', variable: 'SERVICENOW_ENDPOINT')]) {
                        echo "Querying ServiceNow for Task ID: ${env.SN_TASK_ID}"

                        def response = powershell(returnStdout: true, script: """
                            \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                            \$table = "\$env:SERVICENOW_TABLE"
                            \$taskId = "${env.SN_TASK_ID}"
                            
                            # Build the URL with proper query encoding and field restriction
                            \$queryValue = [Uri]::EscapeDataString("number=\$taskId")
                            \$fieldsValue = [Uri]::EscapeDataString("number,state,sys_id,short_description")
                            \$url = \$endpoint + "/api/now/table/" + \$table + "?sysparm_query=" + \$queryValue + "&sysparm_fields=" + \$fieldsValue + "&sysparm_limit=1&sysparm_display_value=true"
                            
                            \$username = "\$env:SN_USER"
                            \$password = "\$env:SN_PASS"
                            
                            # Handle SSL/TLS certificate validation issues with System.Net.WebClient
                            [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \$true }
                            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12 -bor [System.Net.SecurityProtocolType]::Tls11
                            [System.Net.ServicePointManager]::CheckCertificateRevocationList = \$false
                            
                            try {
                                \$webClient = New-Object System.Net.WebClient
                                \$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("\$username`:\$password"))
                                \$webClient.Headers.Add("Authorization", "Basic \$auth")
                                \$webClient.Headers.Add("Accept", "application/json")
                                
                                \$jsonOutput = \$webClient.DownloadString(\$url)
                                \$response = \$jsonOutput | ConvertFrom-Json
                                
                                if (\$response.result -and \$response.result.Count -gt 0) {
                                    \$change = \$response.result[0]
                                    Write-Output (\$change | ConvertTo-Json -Compress)
                                } else {
                                    Write-Output "NOT_FOUND"
                                }
                            } catch {
                                Write-Error "ServiceNow API query failed: \$_"
                                exit 1
                            }
                        """).trim()


                        if (response == "NOT_FOUND") {
                            error("Task ID ${env.SN_TASK_ID} not found in ServiceNow.")
                        } else if (response.isEmpty() || response.startsWith("ERROR")) {
                            error("Failed to query ServiceNow: ${response}")
                        }

                        // Parse JSON response and extract status, sys_id, parent info and other details
                        def jsonSlurper = new groovy.json.JsonSlurper()
                        def taskInfo = jsonSlurper.parseText(response)
                        env.TASK_STATUS = taskInfo.state ?: 'unknown'
                        env.TASK_SHORT_DESC = taskInfo.short_description ?: 'N/A'
                        env.TASK_SYS_ID = taskInfo.sys_id ?: ''
                        
                        // Set DBM_PACKAGE_NAME to parent display_value if available, otherwise to SN_TASK_ID
                        if (params.DBM_PACKAGE_NAME?.trim()) {
                            env.DBM_PACKAGE_NAME = params.DBM_PACKAGE_NAME.trim()
                        } else {
                            env.DBM_PACKAGE_NAME = env.SN_TASK_ID
                        }
                        echo "Using DBmaestro Package Name: ${env.DBM_PACKAGE_NAME}"
                        
                        // Check if Task ID is in closed state (state contains "Closed")
                        if (env.TASK_STATUS?.contains("Closed")) {
                            error("Task ID ${env.SN_TASK_ID} is in closed state and cannot be processed.")
                        }
                        
                        echo "Found Task ID: ${env.SN_TASK_ID} | sys_id: ${env.TASK_SYS_ID} | Status: ${env.TASK_STATUS} | Description: ${env.TASK_SHORT_DESC}"
                    }
                }
            }
        }

        stage('Create Package in DBmaestro') {
            when {
                expression { !params.PACKAGE_ALREADY_EXIST }
            }
            steps {
                withCredentials([usernamePassword(credentialsId: 'dbmaestro-user-automation-token', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    java -jar "${env.DBM_JAR_PATH}" -Build -ProjectName "${env.DBM_PROJECT_NAME}" -EnvName "${env.DBM_ENV_NAME_DEV}" -VersionType "Tasks" -AdditionalInformation "${env.SC_TASK_ID}" -CreatePackage True -PackageName "${env.DBM_PACKAGE_NAME}" -Server "${env.DBM_AGENT_ENDPOINT}" -UseSSL "${env.DBM_USE_SSL}" -AuthType "${env.DBM_AUTH_TYPE}" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }

        // Post a work note to ServiceNow that the DBmaestro package was created
        // Doesn't work for CTASKS
        stage('Post Comment: Package Created') {
            when {
                expression { !params.PACKAGE_ALREADY_EXIST }
            }
            steps {
                script {
                    if (env.TASK_SYS_ID?.trim()) {
                        withCredentials([usernamePassword(credentialsId: 'JENKINS_DBA_USER', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS'), string(credentialsId: 'servicenow-endpoint', variable: 'SERVICENOW_ENDPOINT')]) {
                            powershell """                            # Handle SSL/TLS certificate validation issues
                            [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \$true }
                            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor [System.Net.SecurityProtocolType]::Tls12
                            \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                            \$table = "\$env:SERVICENOW_TABLE"
                            \$sysId = "${env.TASK_SYS_ID}"
                            if ([string]::IsNullOrEmpty(\$sysId)) { Write-Output "SKIP"; exit 0 }
                            \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                            \$overviewUrl = "\$buildUrl/pipeline-overview"
                            \$message = @"
DBmaestro package ${env.DBM_PACKAGE_NAME} created

Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]
"@
                            \$body = @{ work_notes = \$message } | ConvertTo-Json

                            \$username = "\$env:SN_USER"
                            \$password = "\$env:SN_PASS"

                            # Handle SSL/TLS certificate validation issues with System.Net.WebClient
                            [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \$true }
                            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12 -bor [System.Net.SecurityProtocolType]::Tls11
                            [System.Net.ServicePointManager]::CheckCertificateRevocationList = \$false

                            try {
                                \$webClient = New-Object System.Net.WebClient
                                \$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("\$username`:\$password"))
                                \$webClient.Headers.Add("Authorization", "Basic \$auth")
                                \$webClient.Headers.Add("Content-Type", "application/json")
                                \$webClient.Headers.Add("Accept", "application/json")
                                
                                \$uri = \$endpoint + "/api/now/table/" + \$table + "/" + \$sysId
                                \$webClient.UploadString(\$uri, "PATCH", \$body) | Out-Null
                                Write-Output "Posted package-created note to ServiceNow"
                            } catch {
                                Write-Output "Failed to post package-created note: \$_"
                                # do not fail the pipeline for comment posting
                            }
                            """
                        }
                    } else {
                        echo "Skipping ServiceNow comment post: Task sys_id not available"
                    }
                }
            }
        }

        stage('Precheck Package in DBmaestro') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dbmaestro-user-automation-token', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    java -jar "${env.DBM_JAR_PATH}" -PreCheck -ProjectName "${env.DBM_PROJECT_NAME}" -Server "${env.DBM_AGENT_ENDPOINT}" -PackageName "${env.DBM_PACKAGE_NAME}" -UseSSL "${env.DBM_USE_SSL}" -AuthType "${env.DBM_AUTH_TYPE}" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }

        // Post a work note to ServiceNow that the DBmaestro precheck completed
        // Doesn't work for CTASKS
        stage('Post Comment: Precheck Completed') {
            steps {
                script {
                    if (env.TASK_SYS_ID?.trim()) {
                        withCredentials([usernamePassword(credentialsId: 'JENKINS_DBA_USER', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS'), string(credentialsId: 'servicenow-endpoint', variable: 'SERVICENOW_ENDPOINT')]) {
                            powershell """
                            # Handle SSL/TLS certificate validation issues
                            [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \$true }
                            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor [System.Net.SecurityProtocolType]::Tls12
                            
                            \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                            \$table = "\$env:SERVICENOW_TABLE"
                            \$sysId = "${env.TASK_SYS_ID}"
                            if ([string]::IsNullOrEmpty(\$sysId)) { Write-Output "SKIP"; exit 0 }
                            \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                            \$overviewUrl = "\$buildUrl/pipeline-overview"
                            \$message = @"
DBmaestro precheck completed

Package: ${env.DBM_PACKAGE_NAME}
Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]
"@
                            \$body = @{ work_notes = \$message } | ConvertTo-Json

                            \$username = "\$env:SN_USER"
                            \$password = "\$env:SN_PASS"

                            # Handle SSL/TLS certificate validation issues with System.Net.WebClient
                            [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \$true }
                            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12 -bor [System.Net.SecurityProtocolType]::Tls11
                            [System.Net.ServicePointManager]::CheckCertificateRevocationList = \$false

                            try {
                                \$webClient = New-Object System.Net.WebClient
                                \$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("\$username`:\$password"))
                                \$webClient.Headers.Add("Authorization", "Basic \$auth")
                                \$webClient.Headers.Add("Content-Type", "application/json")
                                \$webClient.Headers.Add("Accept", "application/json")
                                
                                \$uri = \$endpoint + "/api/now/table/" + \$table + "/" + \$sysId
                                \$webClient.UploadString(\$uri, "PATCH", \$body) | Out-Null
                                Write-Output "Posted precheck-completed note to ServiceNow"
                            } catch {
                                Write-Output "Failed to post precheck-completed note: \$_"
                            }
                            """
                        }
                    } else {
                        echo "Skipping ServiceNow comment post: Task sys_id not available"
                    }
                }
            }
        }

    stage('Upgrade Target Environment') {
            when {
                expression { params.UPGRADE_RS_ENVIRONMENT }
            }
            steps {
                script {
                    def keepTrying = true
                    while (keepTrying) {
                        try {
                            withCredentials([usernamePassword(credentialsId: 'dbmaestro-user-automation-token', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                                powershell """
                                java -jar "${env.DBM_JAR_PATH}" -Upgrade -ProjectName "${env.DBM_PROJECT_NAME}" -EnvName "${env.DBM_ENV_NAME}" -PackageName "${env.DBM_PACKAGE_NAME}" -BackupBehavior True -RestoreBehavior True -Server "${env.DBM_AGENT_ENDPOINT}" -UseSSL "${env.DBM_USE_SSL}" -AuthType "${env.DBM_AUTH_TYPE}" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                                """
                            }
                            echo "Upgrade succeeded for ${env.DBM_ENV_NAME} - Package: ${env.DBM_PACKAGE_NAME}"
                            // Post success note to ServiceNow (best-effort)
                            if (env.TASK_SYS_ID?.trim()) {
                                withCredentials([usernamePassword(credentialsId: 'JENKINS_DBA_USER', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS'), string(credentialsId: 'servicenow-endpoint', variable: 'SERVICENOW_ENDPOINT')]) {
                                    powershell """
                                    # Handle SSL/TLS certificate validation issues
                                    [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \$true }
                                    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor [System.Net.SecurityProtocolType]::Tls12
                                    
                                    \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                                    \$table = "\$env:SERVICENOW_TABLE"
                                    \$sysId = "${env.TASK_SYS_ID}"
                                    \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                                    \$overviewUrl = "\$buildUrl/pipeline-overview"
                                    \$message = @"
Environment upgrade SUCCEEDED

Environment: ${env.DBM_ENV_NAME}
Package: ${env.DBM_PACKAGE_NAME}
Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]
"@
                                    \$body = @{ work_notes = \$message } | ConvertTo-Json

                                    \$username = "\$env:SN_USER"
                                    \$password = "\$env:SN_PASS"

                                    # Handle SSL/TLS certificate validation issues with System.Net.WebClient
                                    [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \$true }
                                    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12 -bor [System.Net.SecurityProtocolType]::Tls11
                                    [System.Net.ServicePointManager]::CheckCertificateRevocationList = \$false

                                    try {
                                        \$webClient = New-Object System.Net.WebClient
                                        \$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("\$username`:\$password"))
                                        \$webClient.Headers.Add("Authorization", "Basic \$auth")
                                        \$webClient.Headers.Add("Content-Type", "application/json")
                                        \$webClient.Headers.Add("Accept", "application/json")
                                        
                                        \$uri = \$endpoint + "/api/now/table/" + \$table + "/" + \$sysId
                                        \$webClient.UploadString(\$uri, "PATCH", \$body) | Out-Null
                                        Write-Output "Posted upgrade-success note to ServiceNow"
                                    } catch {
                                        Write-Output "Failed to post upgrade-success note: \$_"
                                    }
                                    """
                                }
                            } else {
                                echo "Skipping ServiceNow success comment: Task sys_id not available"
                            }
                            keepTrying = false
                        } catch (err) {
                            echo "Upgrade attempt failed: ${err}"
                            // Post a failure note to ServiceNow (non-fatal for comment posting)
                            try {
                                if (env.TASK_SYS_ID?.trim()) {
                                    withCredentials([usernamePassword(credentialsId: 'JENKINS_DBA_USER', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS'), string(credentialsId: 'servicenow-endpoint', variable: 'SERVICENOW_ENDPOINT')]) {
                                        powershell """
                                        # Handle SSL/TLS certificate validation issues
                                        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \$true }
                                        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor [System.Net.SecurityProtocolType]::Tls12
                                        
                                        \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                                        \$table = "\$env:SERVICENOW_TABLE"
                                        \$sysId = "${env.TASK_SYS_ID}"
                                        \$buildUrl = "${env.BUILD_URL}".TrimEnd('/')
                                        \$overviewUrl = "\$buildUrl/pipeline-overview"
                                        \$message = @"
Environment upgrade FAILED

Environment: ${env.DBM_ENV_NAME}
Package: ${env.DBM_PACKAGE_NAME}
Build: ${env.BUILD_NUMBER} (${env.JOB_NAME})
Build URL: [code]<a href="\$overviewUrl">Pipeline Overview</a>[/code]

Error: ${err}
"@
                                        \$body = @{ work_notes = \$message } | ConvertTo-Json

                                        \$username = "\$env:SN_USER"
                                        \$password = "\$env:SN_PASS"

                                        # Handle SSL/TLS certificate validation issues with System.Net.WebClient
                                        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \$true }
                                        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12 -bor [System.Net.SecurityProtocolType]::Tls11
                                        [System.Net.ServicePointManager]::CheckCertificateRevocationList = \$false

                                        try {
                                            \$webClient = New-Object System.Net.WebClient
                                            \$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("\$username`:\$password"))
                                            \$webClient.Headers.Add("Authorization", "Basic \$auth")
                                            \$webClient.Headers.Add("Content-Type", "application/json")
                                            \$webClient.Headers.Add("Accept", "application/json")
                                            
                                            \$uri = \$endpoint + "/api/now/table/" + \$table + "/" + \$sysId
                                            \$webClient.UploadString(\$uri, "PATCH", \$body) | Out-Null
                                            Write-Output "Posted upgrade-failure note to ServiceNow"
                                        } catch {
                                            Write-Output "Failed to post upgrade-failure note: \$_"
                                        }
                                        """
                                    }
                                } else {
                                    echo "Skipping ServiceNow failure comment: Task sys_id not available"
                                }
                            } catch (postErr) {
                                echo "Posting failure note also failed: ${postErr}"
                            }

                            def action = input message: "Upgrade to ${env.DBM_ENV_NAME} failed for package ${env.DBM_PACKAGE_NAME}. Choose action:", parameters: [choice(name: 'ACTION', choices: 'Retry\nAbort', description: 'Retry will attempt the upgrade again; Abort will stop the pipeline.')], ok: 'Proceed'
                            if (action == 'Abort') {
                                error("Upgrade to ${env.DBM_ENV_NAME} aborted by user after failure.")
                            } else {
                                echo "User chose to retry the upgrade. Retrying..."
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Completed Create-Package pipeline. TASK_ID=${env.SN_TASK_ID} | Final Status=${env.TASK_STATUS}"
        }
        success {
            echo "Successfully created package ${env.DBM_PACKAGE_NAME}."
        }
        failure {
            echo "Pipeline failed for Task ID ${env.SN_TASK_ID}. Review logs for details."
        }
    }
}
