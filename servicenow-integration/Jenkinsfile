pipeline {
    agent any

    parameters {
        string(name: 'CHANGE_REQUEST_ID', defaultValue: 'CHG0030002', description: 'ServiceNow Change Request ID (e.g., CHG0123456)')
        string(name: 'DBM_PROJECT_NAME', defaultValue: 'DemoProject', description: 'DBmaestro project name')
    }

    environment {
        // ServiceNow endpoint and credentials
        SERVICENOW_ENDPOINT = 'https://dev252278.service-now.com'
        SERVICENOW_TABLE = 'change_request'

        // DBmaestro configuration
        DBM_JAR_PATH = 'C:\\Program Files (x86)\\DBmaestro\\DOP Server\\Agent\\DBmaestroAgent.jar'
        DBM_AGENT_ENDPOINT = 'DELL-NICOLAST:8017'
        DBM_ENV_NAME_RS = 'Release Source'
        DBM_ENV_NAME_PROD = 'Prod_Env_1'
        DBM_PROJECT_NAME = "${params.DBM_PROJECT_NAME}"
        DBM_AUTH_TYPE = 'DBmaestroAccount'

        // Poll interval for status checks (in seconds)
        POLL_INTERVAL = '30'
        MAX_WAIT_TIME = '3600'  // 1 hour
    }

    stages {
        stage('Validate Parameters') {
            steps {
                script {
                    if (!params.CHANGE_REQUEST_ID?.trim()) {
                        error("CHANGE_REQUEST_ID parameter is required. Provide a ServiceNow change request ID.")
                    }
                    env.CR_ID = params.CHANGE_REQUEST_ID.trim()
                    echo "Using Change Request ID: ${env.CR_ID}"

                    // Set build display name to the change request ID
                    currentBuild.displayName = "${env.CR_ID}"
                }
            }
        }

        stage('Verify Change Request Exists') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                        echo "Querying ServiceNow for change request: ${env.CR_ID}"

                        def response = powershell(returnStdout: true, script: """
                            \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                            \$table = "\$env:SERVICENOW_TABLE"
                            \$crId = "${env.CR_ID}"
                            
                            # Build the URL with proper query encoding
                            \$queryValue = [Uri]::EscapeDataString("number=\$crId")
                            \$url = \$endpoint + "/api/now/table/" + \$table + "?sysparm_query=" + \$queryValue + "&sysparm_limit=1"
                            
                            \$username = "\$env:SN_USER"
                            \$password = "\$env:SN_PASS"
                            \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                            \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                            \$headers = @{
                                "Accept" = "application/json"
                            }

                            try {
                                \$response = Invoke-RestMethod -Uri \$url -Method Get -Credential \$credential -Headers \$headers -ErrorAction Stop
                                if (\$response.result.Count -gt 0) {
                                    \$change = \$response.result[0]
                                    Write-Output (\$change | ConvertTo-Json -Compress)
                                } else {
                                    Write-Output "NOT_FOUND"
                                }
                            } catch {
                                Write-Error "ServiceNow API query failed: \$_"
                                exit 1
                            }
                        """).trim()

                        if (response == "NOT_FOUND") {
                            error("Change Request ${env.CR_ID} not found in ServiceNow.")
                        } else if (response.isEmpty() || response.startsWith("ERROR")) {
                            error("Failed to query ServiceNow: ${response}")
                        }

                        // Parse JSON response and extract status and other details
                        def jsonSlurper = new groovy.json.JsonSlurper()
                        def changeInfo = jsonSlurper.parseText(response)
                        env.CR_STATUS = changeInfo.state ?: 'unknown'
                        env.CR_SHORT_DESC = changeInfo.short_description ?: 'N/A'
                        echo "Found Change Request: ${env.CR_ID} | Status: ${env.CR_STATUS} | Description: ${env.CR_SHORT_DESC}"
                    }
                }
            }
        }

        stage('Create Package in DBmaestro') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    java -jar "\$env:DBM_JAR_PATH" -Build -ProjectName "\$env:DBM_PROJECT_NAME" -EnvName "Dev_Env_1" -VersionType "Tasks" -AdditionalInformation "${env.CR_ID}" -CreatePackage True -PackageName "${env.CR_ID}" -Server "\$env:DBM_AGENT_ENDPOINT" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }

        stage('Precheck Package in DBmaestro') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    java -jar "\$env:DBM_JAR_PATH" -PreCheck -ProjectName "\$env:DBM_PROJECT_NAME" -Server "\$env:DBM_AGENT_ENDPOINT" -PackageName "${env.CR_ID}" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }

        stage('Wait for Change to be Scheduled') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                        echo "Waiting for change request ${env.CR_ID} to reach 'scheduled' status..."

                        def maxWaitSeconds = Integer.parseInt(env.MAX_WAIT_TIME)
                        def pollIntervalSeconds = Integer.parseInt(env.POLL_INTERVAL)
                        def elapsedTime = 0
                        def isScheduled = false

                        while (elapsedTime < maxWaitSeconds && !isScheduled) {
                            sleep(time: pollIntervalSeconds, unit: 'SECONDS')
                            elapsedTime += pollIntervalSeconds

                            def response = powershell(returnStdout: true, script: """
                                \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                                \$table = "\$env:SERVICENOW_TABLE"
                                \$crId = "${env.CR_ID}"
                                
                                # Build the URL with proper query encoding
                                \$queryValue = [Uri]::EscapeDataString("number=\$crId")
                                \$url = \$endpoint + "/api/now/table/" + \$table + "?sysparm_query=" + \$queryValue + "&sysparm_limit=1"
                                
                                \$username = "\$env:SN_USER"
                                \$password = "\$env:SN_PASS"
                                \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                                \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                                \$headers = @{
                                    "Accept" = "application/json"
                                }

                                try {
                                    \$response = Invoke-RestMethod -Uri \$url -Method Get -Credential \$credential -Headers \$headers -ErrorAction Stop
                                    if (\$response.result.Count -gt 0) {
                                        \$change = \$response.result[0]
                                        Write-Output \$change.state
                                    }
                                } catch {
                                    Write-Error "ServiceNow API query failed: \$_"
                                    exit 1
                                }
                            """).trim()

                            if (response == "-2" || response.contains("-2")) {
                                isScheduled = true
                                echo "Change request reached 'scheduled' status."
                            } else {
                                echo "Current status: ${response} | Elapsed time: ${elapsedTime}s / ${maxWaitSeconds}s"
                            }
                        }

                        if (!isScheduled) {
                            error("Timeout waiting for change request to be scheduled. Max wait time: ${env.MAX_WAIT_TIME}s")
                        }
                    }
                }
            }
        }

        stage('Upgrade Release Source Environment') {
            steps {
                script {
                    def keepTrying = true
                    while (keepTrying) {
                        try {
                            withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                                powershell """
                                java -jar "\$env:DBM_JAR_PATH" -Upgrade -ProjectName "\$env:DBM_PROJECT_NAME" -EnvName "\$env:DBM_ENV_NAME_RS" -PackageName "${env.CR_ID}" -BackupBehavior True -RestoreBehavior True -Server "\$env:DBM_AGENT_ENDPOINT" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                                """
                            }
                            echo "Release Source upgrade succeeded for package ${env.CR_ID}"
                            keepTrying = false
                        } catch (err) {
                            echo "Upgrade attempt failed: ${err}"
                            def action = input message: "Upgrade failed for package ${env.CR_ID}. Choose action:", parameters: [choice(name: 'ACTION', choices: 'Retry\nAbort', description: 'Retry will attempt the upgrade again; Abort will stop the pipeline.')], ok: 'Proceed'
                            if (action == 'Abort') {
                                error("Upgrade aborted by user after failure.")
                            } else {
                                echo "User chose to retry the upgrade. Retrying..."
                            }
                        }
                    }
                }
            }
        }

        stage('Wait for Change to be Implemented') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'servicenow-api-creds', usernameVariable: 'SN_USER', passwordVariable: 'SN_PASS')]) {
                        echo "Waiting for change request ${env.CR_ID} to reach 'implement' status..."

                        def maxWaitSeconds = Integer.parseInt(env.MAX_WAIT_TIME)
                        def pollIntervalSeconds = Integer.parseInt(env.POLL_INTERVAL)
                        def elapsedTime = 0
                        def isImplemented = false

                        while (elapsedTime < maxWaitSeconds && !isImplemented) {
                            sleep(time: pollIntervalSeconds, unit: 'SECONDS')
                            elapsedTime += pollIntervalSeconds

                            def response = powershell(returnStdout: true, script: """
                                \$endpoint = "\$env:SERVICENOW_ENDPOINT"
                                \$table = "\$env:SERVICENOW_TABLE"
                                \$crId = "${env.CR_ID}"
                                
                                # Build the URL with proper query encoding
                                \$queryValue = [Uri]::EscapeDataString("number=\$crId")
                                \$url = \$endpoint + "/api/now/table/" + \$table + "?sysparm_query=" + \$queryValue + "&sysparm_limit=1"
                                
                                \$username = "\$env:SN_USER"
                                \$password = "\$env:SN_PASS"
                                \$securePassword = ConvertTo-SecureString \$password -AsPlainText -Force
                                \$credential = New-Object System.Management.Automation.PSCredential(\$username, \$securePassword)

                                \$headers = @{
                                    "Accept" = "application/json"
                                }

                                try {
                                    \$response = Invoke-RestMethod -Uri \$url -Method Get -Credential \$credential -Headers \$headers -ErrorAction Stop
                                    if (\$response.result.Count -gt 0) {
                                        \$change = \$response.result[0]
                                        Write-Output \$change.state
                                    }
                                } catch {
                                    Write-Error "ServiceNow API query failed: \$_"
                                    exit 1
                                }
                            """).trim()

                            if (response == "-1" || response.contains("-1")) {
                                isImplemented = true
                                echo "Change request reached 'implement' status."
                            } else {
                                echo "Current status: ${response} | Elapsed time: ${elapsedTime}s / ${maxWaitSeconds}s"
                            }
                        }

                        if (!isImplemented) {
                            error("Timeout waiting for change request to be implemented. Max wait time: ${env.MAX_WAIT_TIME}s")
                        }
                    }
                }
            }
        }

        stage('Upgrade Production Environment') {
            steps {
                script {
                    def keepTrying = true
                    while (keepTrying) {
                        try {
                            withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                                powershell """
                                java -jar "\$env:DBM_JAR_PATH" -Upgrade -ProjectName "\$env:DBM_PROJECT_NAME" -EnvName "\$env:DBM_ENV_NAME_PROD" -PackageName "${env.CR_ID}" -BackupBehavior True -RestoreBehavior True -Server "\$env:DBM_AGENT_ENDPOINT" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                                """
                            }
                            echo "Production upgrade succeeded for package ${env.CR_ID}"
                            keepTrying = false
                        } catch (err) {
                            echo "Production upgrade attempt failed: ${err}"
                            def action = input message: "Production upgrade failed for package ${env.CR_ID}. Choose action:", parameters: [choice(name: 'ACTION', choices: 'Retry\nAbort', description: 'Retry will attempt the upgrade again; Abort will stop the pipeline.')], ok: 'Proceed'
                            if (action == 'Abort') {
                                error("Production upgrade aborted by user after failure.")
                            } else {
                                echo "User chose to retry the production upgrade. Retrying..."
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Completed ServiceNow change integration pipeline. CR_ID=${env.CR_ID} | Final Status=${env.CR_STATUS}"
        }
        success {
            echo "Successfully deployed change request ${env.CR_ID} through all environments."
        }
        failure {
            echo "Pipeline failed for change request ${env.CR_ID}. Review logs for details."
        }
    }
}
