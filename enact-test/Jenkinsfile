pipeline {
    agent any
    // Make project and environment configurable at build time with sensible defaults
    parameters {
        string(name: 'DBM_PROJECT_NAME', defaultValue: 'DemoProject', description: 'DBmaestro project name')
    // DBM_ENV_NAME_DEV is set as an environment variable below (not a build parameter)
        // Optional: if provided, use this Task ID instead of parsing from the commit message
        string(name: 'DBM_TASK_ID', defaultValue: '', description: 'Optional DBmaestro Task ID; if empty, extracted from the latest commit message')
    }
    // Poll SCM every 2 minutes
    triggers {
        pollSCM('H/2 * * * *')
    }
    environment {
    // Path to the DBmaestro Agent JAR on the Windows agent
    // Note: keep backslashes escaped for Groovy strings
    DBM_JAR_PATH = 'C:\\Program Files (x86)\\DBmaestro\\DOP Server\\Agent\\DBmaestroAgent.jar'
    // DBmaestro agent endpoint (host:port)
    DBM_AGENT_ENDPOINT = 'DELL-NICOLAST:8017'
    // Release Source environment name
    DBM_ENV_NAME_RS = 'Release Source'
    // Production environment name
    DBM_ENV_NAME_PROD = 'Prod_Env_1'
    // Project and environment for DBmaestro (sourced from build parameters)
    DBM_PROJECT_NAME = "${params.DBM_PROJECT_NAME}"
    // Dev environment name (configured in the Jenkinsfile)
    DBM_ENV_NAME_DEV = 'Dev_Env_1'
        // Auth type for DBmaestro (e.g. DBmaestroAccount)
        DBM_AUTH_TYPE = 'DBmaestroAccount'
    }
    stages {
        stage('Checkout') {
            steps {
                // Checkout the specified repository directly (change branch if needed)
                // Use the GitHub token credential 'gh_user_token' to authenticate cloning the private repo
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], doGenerateSubmoduleConfigurations: false, extensions: [], userRemoteConfigs: [[url: 'https://github.com/DBMaestroDev/source-control-example.git', credentialsId: 'gh_user_token']]])
            }
        }

        stage('Detect TaskID') {
            steps {
                script {
                    // If DBM_TASK_ID parameter was provided, use it. Otherwise, extract from commit message.
                    if (params.DBM_TASK_ID?.trim()) {
                        env.TASK_ID = params.DBM_TASK_ID.trim()
                        echo "Using provided DBM_TASK_ID: ${env.TASK_ID}"
                    } else {
                        // Get the most recent commit message
                        def commitMsg = powershell(returnStdout: true, script: 'git --no-pager log -1 --pretty=%B').trim()
                        echo "Commit message:\n${commitMsg}"

                        // Look for a line containing: TaskID: <value>
                        def matcher = (commitMsg =~ /(?m)TaskID:\s*(\S+)/)
                        if (matcher) {
                            env.TASK_ID = matcher[0][1]
                            echo "Found TaskID: ${env.TASK_ID}"
                        } else {
                            // Fail the build if no TaskID is present in the commit message
                            error("No TaskID found in commit message â€” failing the build.")
                        }
                    }
                }
            }
        }

        stage('Create Package in DBmaestro') {
            steps {
                // Use Jenkins credentials 'dbm_credentials' (username/password) instead of hardcoding
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    // Run the requested PowerShell command, substituting the detected TASK_ID and credential vars
                    powershell """
                    java -jar "\$env:DBM_JAR_PATH" -Build -ProjectName "\$env:DBM_PROJECT_NAME" -EnvName "\$env:DBM_ENV_NAME_DEV" -VersionType "Tasks" -AdditionalInformation "${env.TASK_ID}" -CreatePackage True -PackageName "${env.TASK_ID}" -Server "\$env:DBM_AGENT_ENDPOINT" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }

        stage('Precheck Package in DBmaestro') {
            steps {
                // Use Jenkins credentials 'dbm_credentials' (username/password) to run a pre-check
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    java -jar "\$env:DBM_JAR_PATH" -PreCheck -ProjectName "\$env:DBM_PROJECT_NAME" -Server "\$env:DBM_AGENT_ENDPOINT" -PackageName "${env.TASK_ID}" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }

        stage('Manual apporval - Release Source') {
            steps {
                // Pause the pipeline and wait for a human to approve the upgrade
                script {
                    timeout(time: 4, unit: 'HOURS') {
                        input message: "Manual verification required - approve Upgrade for package ${env.TASK_ID}", ok: 'Approve'
                    }
                }
            }
        }

        stage('Upgrade Release Source Environment') {
            steps {
                // Use Jenkins credentials 'dbm_credentials' (username/password) to run upgrade
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    java -jar "\$env:DBM_JAR_PATH" -Upgrade -ProjectName "\$env:DBM_PROJECT_NAME" -EnvName "\$env:DBM_ENV_NAME_RS" -PackageName "${env.TASK_ID}" -BackupBehavior True -RestoreBehavior True -Server "\$env:DBM_AGENT_ENDPOINT" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }

        stage('Manual approval - Production') {
            steps {
                // Pause the pipeline and wait for a human to approve the production upgrade
                script {
                    timeout(time: 4, unit: 'HOURS') {
                        input message: "Manual approval required - approve Production Upgrade for package ${env.TASK_ID}", ok: 'Approve'
                    }
                }
            }
        }

        stage('Upgrade Production Environment') {
            steps {
                // Use Jenkins credentials 'dbm_credentials' (username/password) to run production upgrade
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    java -jar "\$env:DBM_JAR_PATH" -Upgrade -ProjectName "\$env:DBM_PROJECT_NAME" -EnvName "\$env:DBM_ENV_NAME_PROD" -PackageName "${env.TASK_ID}" -BackupBehavior True -RestoreBehavior True -Server "\$env:DBM_AGENT_ENDPOINT" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "\$env:DBM_USER" -Password "\$env:DBM_PASS"
                    """
                }
            }
        }
    }
    post {
        always {
            echo "Completed pipeline. TASK_ID=${env.TASK_ID}"
        }
    }
}
