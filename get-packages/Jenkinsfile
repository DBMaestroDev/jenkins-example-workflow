pipeline {
    agent any

    parameters {
        choice(name: 'DBM_PROJECT_NAME', choices: ['DemoProject', 'DemoProject2', 'DemoProject3', 'DemoProject4'], description: 'DBmaestro project name')
    }

    environment {
        // DBmaestro configuration (same as servicenow-integration pipeline)
        DBM_JAR_PATH = 'C:\\Program Files (x86)\\DBmaestro\\DOP Server\\Agent\\DBmaestroAgent.jar'
        DBM_AGENT_ENDPOINT = 'DELL-NICOLAST:8017'
        DBM_AUTH_TYPE = 'DBmaestroAccount'
    }

    stages {
        stage('Get Packages from DBmaestro') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    \$jar = "\$env:DBM_JAR_PATH"
                    \$project = "${params.DBM_PROJECT_NAME}"
                    \$server = "\$env:DBM_AGENT_ENDPOINT"
                    \$outFile = "packages.json"

                    Write-Output "Running DBmaestroAgent -GetPackages..."
                    & java -jar "\$jar" -GetPackages -ProjectName "\$project" -FilePath "\$outFile" -Server "\$server" -UseSSL True -AuthType "\$env:DBM_AUTH_TYPE" -UserName "${DBM_USER}" -Password "${DBM_PASS}"
                    
                    if (Test-Path \$outFile) {
                        Write-Output "Successfully created: \$outFile"
                    } else {
                        throw "Failed to create packages.json"
                    }
                    """
                }
            }
        }

        stage('Parse and Display Packages') {
            steps {
                powershell """
                \$scriptPath = Join-Path \$PWD "get-packages\\extract-packages.ps1"
                \$packagesFile = "packages.json"
                
                if (-not (Test-Path \$packagesFile)) {
                    throw "packages.json not found. GetPackages stage may have failed."
                }
                
                Write-Output "Parsing packages from: \$packagesFile"
                & powershell -NoProfile -ExecutionPolicy Bypass -File \$scriptPath -FilePath \$packagesFile
                """
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'packages.json', allowEmptyArchive: true
        }
    }
}

