pipeline {
    agent any

    parameters {
        string(name: 'DBM_PROJECT_NAME', defaultValue: 'DemoProject', description: 'DBmaestro project name')
        string(name: 'DBM_AGENT_ENDPOINT', defaultValue: 'DELL-NICOLAST:8017', description: 'DBmaestro agent endpoint')
        string(name: 'DBM_JAR_PATH', defaultValue: 'DBmaestroAgent.jar', description: 'Path to DBmaestroAgent.jar on the agent')
    }

    stages {
        stage('Get Packages from DBmaestro') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dbm_credentials', usernameVariable: 'DBM_USER', passwordVariable: 'DBM_PASS')]) {
                    powershell """
                    \$jar = "${params.DBM_JAR_PATH}"
                    \$project = "${params.DBM_PROJECT_NAME}"
                    \$server = "${params.DBM_AGENT_ENDPOINT}"
                    \$outFile = "packages.json"

                    Write-Output "Running DBmaestroAgent -GetPackages..."
                    & java -jar "\$jar" -GetPackages -ProjectName "\$project" -FilePath "\$outFile" -Server "\$server" -UseSSL True -AuthType DBmaestroAccount -UserName "${DBM_USER}" -Password "${DBM_PASS}"
                    
                    if (Test-Path \$outFile) {
                        Write-Output "Successfully created: \$outFile"
                    } else {
                        throw "Failed to create packages.json"
                    }
                    """
                }
            }
        }

        stage('Parse and Display Packages') {
            steps {
                powershell """
                \$scriptPath = Join-Path \$PWD "get-packages\\extract-packages.ps1"
                \$packagesFile = "packages.json"
                
                if (-not (Test-Path \$packagesFile)) {
                    throw "packages.json not found. GetPackages stage may have failed."
                }
                
                Write-Output "Parsing packages from: \$packagesFile"
                & powershell -NoProfile -ExecutionPolicy Bypass -File \$scriptPath -FilePath \$packagesFile
                """
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'packages.json', allowEmptyArchive: true
        }
    }
}

